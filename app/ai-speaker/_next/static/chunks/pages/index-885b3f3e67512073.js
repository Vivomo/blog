(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{4076:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return s(6826)}])},6826:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return Home}});var n=s(1527),a=s(959),r=s(6666),i=s(8575),l=s(5583);let o="ai_chatLogs",getMessageStore=()=>{let e=(0,r.tv)(o);return e||(e={},(0,r.co)(o,e)),e},getMessage=e=>{let t=getMessageStore();return t[e]||[]},chatStorage_updateMessage=(e,t)=>{let s=getMessageStore();s[e]=t,(0,r.co)(o,s)},getSessionStore=()=>{let e=(0,r.tv)(i.zo),t=l.Z.getList()[0];if(!e){let e={name:"chat",assistant:t.id,id:Date.now().toString()},s=[e];chatStorage_updateMessage(e.id,[]),(0,r.co)(i.zo,s)}return e},updateSessionStore=e=>{(0,r.co)(i.zo,e)},addSession=e=>{let t=getSessionStore();return t.push(e),updateSessionStore(t),t},getSession=e=>{let t=getSessionStore(),s=t.find(t=>t.id===e);if(!s)return null;let{assistant:n}=s,a=l.Z.getAssistant(n);return a||(a=l.Z.getList()[0],chatStorage_updateSession(s.id,{assistant:a.id})),{...s,assistant:a}},chatStorage_updateSession=(e,t)=>{let s=getSessionStore(),n=s.findIndex(t=>t.id===e);return n>-1&&(s[n]={...s[n],...t},updateSessionStore(s)),s},chatStorage_removeSession=e=>{let t=getSessionStore(),s=t.filter(t=>t.id!==e);return updateSessionStore(s),s};let ChatService=class ChatService{static getInstance(){return ChatService.instance||(ChatService.instance=new ChatService),ChatService.instance}async getStream(e){var t,s,n;let{prompt:a,history:r=[],options:i={}}=e,l="";console.log(JSON.stringify({prompt:a,history:r,options:i}));try{let e=await fetch("/api/chat",{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({prompt:a,history:r,options:i}),signal:this.controller.signal}),s=e.body;if(!s)return;let n=s.getReader(),o=new TextDecoder("utf-8"),c=!1;for(;!c;){let{value:s,done:a}=await n.read();c=a;let r=o.decode(s);500===e.status?l="service error":l+=r,null===(t=this.actions)||void 0===t||t.onCompleting(l),await new Promise(e=>setTimeout(e,100))}}catch(e){}finally{null===(n=this.actions)||void 0===n||null===(s=n.onCompleted)||void 0===s||s.call(n,l),this.controller=new AbortController}}cancel(){this.controller.abort()}constructor(){this.controller=new AbortController}};let c=ChatService.getInstance();var d=s(8456),u=s(1494);s(5083);var m=s(2883),g=s.n(m);let Markdown=e=>{let t=new d.TU.Renderer;t.code=(e,t)=>{let s=u.Z.getLanguage(t)?t:"plaintext",n=u.Z.highlight(s,e).value;return'<pre><code class="hljs '.concat(s,'" style="border-radius: 5px" >').concat(n,"</code></pre>")};let s=e.markdownText;d.TU.setOptions({renderer:t});let a=(0,d.TU)(s);return(0,n.jsx)("div",{dangerouslySetInnerHTML:{__html:a},className:g().mark})};var h=s(8224),x=s(9104),p=s(7434),f=s(3908),S=s(7102),v=s(932),w=s.n(v);let j=new(w())({bitRate:1128});function Voice(e){let{sessionId:t,assistant:s}=e,[r,i]=(0,a.useState)(!1),[l,o]=(0,a.useState)(!1),[c,d]=(0,a.useState)(!1),[u,m]=(0,a.useState)(!1),g=(0,a.useMemo)(()=>c||!l||u,[c,l,u]);(0,a.useEffect)(()=>{navigator.getUserMedia({audio:!0},()=>{o(!0)},()=>{o(!1)})});let start=()=>{j.start().then(()=>{i(!0)})},end=()=>{j.stop().getMp3().then(e=>{let[t,s]=e;i(!1),answer(s)})},updateMessage=e=>{let s=getMessage(t);chatStorage_updateMessage(t,[...s,...e])},answer=async e=>{d(!0);let n=getMessage(t),a=new FormData;a.append("file",e,"prompt.mp3"),a.append("options",JSON.stringify(s)),a.append("history",JSON.stringify(n.slice(-s.max_log)));let r=await fetch("/api/voice",{method:"POST",body:a}),{audioUrl:i,transcription:l,completion:o}=await r.json();d(!1),updateMessage([{role:"user",content:l},{role:"assistant",content:o}]);let c=new Audio("data:audio/wav;base64,".concat(i));c.addEventListener("play",()=>{m(!0)}),c.addEventListener("ended",()=>{m(!1)}),c.play()};return(0,n.jsxs)("div",{className:"w-full h-full flex flex-col items-center justify-center",children:[c?(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)(x.Z,{size:"1rem",className:"animate-spin mr-2"}),"Loading..."]}):u?(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)(p.Z,{className:"animate-ping mr-2",size:"1rem"}),"Playing"]}):(0,n.jsxs)("div",{className:"text-gray-600 flex items-center",children:[(0,n.jsx)(f.Z,{className:"mr-2",size:"1rem"}),"Hold to ask~"]}),(0,n.jsx)(h.A,{className:"mt-4",size:"4rem",disabled:g,onPointerDown:start,onPointerUp:end,onMouseDown:start,onMouseUp:end,children:(0,n.jsx)(S.Z,{color:r?"red":"green"})})]})}var y=s(7082),b=s(712),N=s(6947),_=s(707),k=s(9938),C=s(429),Z=s.n(C),M=s(5052),z=s(8132);let ThemeSwitch=()=>{let{colorScheme:e,toggleColorScheme:t}=(0,y.X)(),[s,r]=(0,a.useState)((0,n.jsx)(M.Z,{}));return(0,a.useEffect)(()=>{r("dark"===e?(0,n.jsx)(M.Z,{}):(0,n.jsx)(z.Z,{}))},[e]),(0,n.jsx)(h.A,{variant:"subtle",size:"xs",onClick:()=>t("light"===e?"dark":"light"),children:s})};var D=s(2622);let AssistantSelect=e=>{let{value:t,loading:s=!1,onChange:r}=e,[i,o]=(0,a.useState)([]);return(0,a.useEffect)(()=>{let e=l.Z.getList();o(e)},[]),(0,n.jsx)(D.Ph,{size:"sm",onChange:e=>{let t=i.find(t=>t.id===e);r(t)},value:t,className:"w-32 mx-2",disabled:s,data:i.map(e=>({value:e.id,label:e.name}))})};var L=s(1118),E=s(1928),T=s(1906),A=s(3174),I=s(2242),O=s(4943),P=s(5924);let Message=e=>{let{sessionId:t}=e,[s,r]=(0,a.useState)(""),[l,o]=(0,a.useState)(!1),[d,u]=(0,a.useState)([]),[m,g]=(0,a.useState)(),[x,p]=(0,a.useState)("text"),{colorScheme:f}=(0,y.X)(),updateMessage=e=>{u(e),chatStorage_updateMessage(t,e)};c.actions={onCompleting:e=>setSuggestion(e),onCompleted:()=>{o(!1)}},(0,a.useEffect)(()=>{let e=getSession(t);g(null==e?void 0:e.assistant);let s=getMessage(t);u(s),l&&c.cancel()},[t,x]);let onClear=()=>{updateMessage([])},onKeyDown=e=>{13!==e.keyCode||e.shiftKey||(e.preventDefault(),onSubmit())},setSuggestion=e=>{if(""===e)return;let t=d.length,s=t?d[t-1]:null;setMessages((null==s?void 0:s.role)==="assistant"?[...d.slice(0,t-1),{...s,content:e}]:[...d,{role:"assistant",content:e}])},setMessages=e=>{u(e),chatStorage_updateMessage(t,e)},onSubmit=()=>{if(l)return c.cancel();if(!s.trim())return;let e=[...d,{role:"user",content:s}];setMessages(e),o(!0),c.getStream({prompt:s,options:m,history:e.slice(-(null==m?void 0:m.max_log))}),r("")};return(0,n.jsxs)("div",{className:"flex flex-col h-screen w-full",children:[(0,n.jsxs)("div",{className:(0,P.Z)(["flex","justify-between","items-center","p-4","shadow-sm","h-[6rem]"]),children:[(0,n.jsxs)(b.J,{width:100,position:"bottom",withArrow:!0,shadow:"sm",children:[(0,n.jsx)(b.J.Target,{children:(0,n.jsx)(N.z,{size:"sm",variant:"subtle",className:"px-1",rightIcon:(0,n.jsx)(L.Z,{size:"1rem"}),children:"AI 助理"})}),(0,n.jsx)(b.J.Dropdown,{children:(0,n.jsx)(Z(),{href:"/assistant",className:"no-underline text-green-600",children:"助理管理"})})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)(AssistantSelect,{value:null==m?void 0:m.id,onChange:e=>{g(e),chatStorage_updateSession(t,{assistant:e.id})}}),(0,n.jsx)(h.A,{size:"sm",onClick:()=>p("text"===x?"voice":"text"),children:"text"===x?(0,n.jsx)(E.Z,{color:"green",size:"1rem"}):(0,n.jsx)(T.Z,{color:"gray",size:"1rem"})})]}),(0,n.jsx)(ThemeSwitch,{})]}),"text"===x?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:(0,P.Z)(["flex-col","h-[calc(100vh-10rem)]","w-full","overflow-y-auto","rounded-sm","px-8"]),children:d.map((e,t)=>{let s="user"===e.role;return(0,n.jsxs)("div",{className:(0,P.Z)({flex:"user"===e.role,"flex-col":"user"===e.role,"items-end":"user"===e.role},"mt-4"),children:[(0,n.jsxs)("div",{children:[i.W$[e.role],!s&&t===d.length-1&&l&&(0,n.jsx)(_.a,{size:"sm",variant:"dots",className:"ml-2"})]}),(0,n.jsx)("div",{className:(0,P.Z)({"bg-gray-100":"light"===f,"bg-zinc-700/40":"dark"===f,"whitespace-break-spaces":s},"rounded-md","shadow-md","px-4","py-2","mt-1","w-full","max-w-4xl","min-h-[3rem]"),children:s?(0,n.jsx)("div",{children:e.content}):(0,n.jsx)(Markdown,{markdownText:e.content})})]},"".concat(e.role,"-").concat(t))})}),(0,n.jsxs)("div",{className:(0,P.Z)("flex","items-center","justify-center","self-end","my-4","w-full"),children:[(0,n.jsx)(h.A,{className:"mr-2",disabled:l,onClick:()=>onClear(),children:(0,n.jsx)(A.Z,{})}),(0,n.jsx)(k.g,{placeholder:"Enter 发送消息；Shift + Enter 换行；",className:"w-3/5",value:s,disabled:l,onKeyDown:e=>onKeyDown(e),onChange:e=>r(e.target.value)}),(0,n.jsx)(h.A,{color:"green",className:"ml-2",onClick:()=>onSubmit(),children:l?(0,n.jsx)(I.Z,{}):(0,n.jsx)(O.Z,{})})]})]}):(0,n.jsx)("div",{className:"h-[calc(100vh-6rem)] w-full",children:(0,n.jsx)(Voice,{sessionId:t,assistant:m})})]})};var J=s(8234),R=s(8998);let EditableText=e=>{let[t,s]=(0,a.useState)(!1),[r,i]=(0,a.useState)(e.text);return t?(0,n.jsx)("input",{className:(0,P.Z)(["w-[10rem]","flex","items-center","h-[2rem]","outline-none","border-0"]),type:"text",value:r,onKeyDown:t=>{13===t.keyCode&&(s(!1),e.onSave(r))},onChange:e=>{i(e.target.value)},onBlur:()=>{t&&(s(!1),i(e.text))},autoFocus:!0}):(0,n.jsx)("div",{className:(0,P.Z)(["leading-9","w-[10rem]","h-[2rem]","overflow-hidden","text-ellipsis","whitespace-nowrap"]),onDoubleClick:()=>{s(!0)},children:r})},generateItemClasses=(e,t,s)=>(0,P.Z)(["flex cursor-pointer h-[2.4rem] items-center justify-around group px-4 rounded-md",{"hover:bg-gray-300/60":"light"===s,"bg-gray-200/60":e!==t&&"light"===s,"bg-gray-300":e===t&&"light"===s,"hover:bg-zinc-800/50":"dark"===s,"bg-zinc-800/20":e!==t&&"dark"===s,"bg-zinc-800/90":e===t&&"dark"===s}]),Session=e=>{let{sessionId:t,onChange:s,className:r}=e,[i,o]=(0,a.useState)([]),{colorScheme:c}=(0,y.X)();(0,a.useEffect)(()=>{let e=getSessionStore();o(e)},[]);let createSession=()=>{let e=l.Z.getList(),t={name:"session-".concat(i.length+1),assistant:e[0].id,id:Date.now().toString()};s(t.id),o(addSession(t))},removeSession=e=>{let n=chatStorage_removeSession(e);t===e&&s(n[0].id),o(n)},updateSession=e=>{o(chatStorage_updateSession(t,{name:e}))};return(0,n.jsxs)("div",{className:(0,P.Z)({"bg-black/10":"dark"===c,"bg-gray-100":"light"===c},"h-screen","w-64","flex","flex-col","px-2",r),children:[(0,n.jsx)("div",{className:"flex justify-center py-2 w-full",children:(0,n.jsx)(h.A,{onClick:()=>createSession(),color:"green",size:"sm",children:(0,n.jsx)(J.Z,{size:"1rem"})})}),(0,n.jsx)("div",{className:(0,P.Z)(["pb-4","overflow-y-auto","scrollbar-none","flex","flex-col","gap-y-2"]),children:i.map(e=>{let{id:a,name:r}=e;return(0,n.jsxs)("div",{className:generateItemClasses(a,t,c),onClick:()=>s(a),children:[(0,n.jsx)(EditableText,{text:r,onSave:e=>updateSession(e)}),i.length>1?(0,n.jsx)(R.Z,{size:".8rem",color:"gray",onClick:e=>{e.stopPropagation(),removeSession(a)},className:"mx-1 invisible group-hover:visible"}):null]},a)})})]})};var U=s(329);let Chat=()=>{let[e,t]=(0,a.useState)("");return(0,a.useEffect)(()=>{(()=>{let e=getSessionStore(),s=e[0].id;t(s)})()},[]),(0,n.jsxs)("div",{className:"h-screen flex w-screen",children:[(0,n.jsx)(U.z,{smallerThan:"md",styles:{width:"0 !important",padding:"0 !important",overflow:"hidden"},children:(0,n.jsx)(Session,{sessionId:e,onChange:t})}),(0,n.jsx)(Message,{sessionId:e})]})};function Home(){return(0,n.jsx)("div",{children:(0,n.jsx)(Chat,{})})}},5583:function(e,t,s){"use strict";var n=s(6666),a=s(8575);let getList=()=>{let e=(0,n.tv)(a.zR)||[];return a.pl.concat(e)},updateList=e=>{(0,n.co)(a.zR,e.filter(e=>!e.system))};t.Z={getList,addAssistant:e=>{let t=getList();return t.push(e),updateList(t),t},updateAssistant:(e,t)=>{let s=getList(),n=s.findIndex(t=>t.id===e);return n>-1&&(s[n]={...s[n],...t},updateList(s)),s},removeAssistant:e=>{let t=getList(),s=t.filter(t=>t.id!==e);return updateList(s),s},getAssistant:e=>{let t=getList();return t.find(t=>t.id===e)||null}}},8575:function(e,t,s){"use strict";s.d(t,{W$:function(){return l},bH:function(){return r},pl:function(){return i},zR:function(){return a},zo:function(){return n}});let n="ai_assistant_session",a="ai_assistant_assistant",r="ai_assistant_api_key",i=[{name:"英语 助手",prompt:"Please be my English teacher, if I made any mistakes in words, tense, or grammar in our conversation, please correct me and give me an proper sample sentence, if I use chinese, please translate it,thanks",temperature:.7,max_log:4,max_tokens:800,id:"1",system:!0},{name:"编程 助手",prompt:"你是一个编程助手，任务是详细地回答用户的每个编程问题",temperature:.7,max_log:10,max_tokens:2e3,id:"2",system:!0}],l={user:"\uD83D\uDC68‍\uD83D\uDCBB‍",assistant:"\uD83E\uDD16",system:"\uD83D\uDD78"}},6666:function(e,t,s){"use strict";function setLocal(e,t){window.localStorage.setItem(e,JSON.stringify(t))}function getLocal(e){let t=window.localStorage.getItem(e);return t?JSON.parse(t):null}s.d(t,{co:function(){return setLocal},tv:function(){return getLocal}})},2883:function(e){e.exports={mark:"Markdown_mark__tNwkO"}}},function(e){e.O(0,[680,65,159,774,888,179],function(){return e(e.s=4076)}),_N_E=e.O()}]);