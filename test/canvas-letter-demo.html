<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Canvas letter</title>
    <style>
        canvas {
            background: #222;
        }
    </style>
</head>
<body>
<canvas id="canvas-logo"></canvas>

<script>
    const particleLogo = (function () {
        let config = {
            space: 10,
            w: window.innerWidth,
            h: window.innerHeight,
            moveDistance: 5, // 影响速度
            pointRadius: 2,
            maxR: 4,
            minR: 1,
            normalR: 2,
        };

        let canvas = document.getElementById('canvas-logo');
        canvas.width = config.w;
        canvas.height = config.h;
        let ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(255,255,255, 1)';

        let points = [];
        let pointsCount = 0;
        let finishedPointsCount = 0;

        function randomRadius() {
            let r = Math.random();
            if (r < 0.85) {
                return config.normalR;
            } else if (r < 0.95) {
                return config.minR
            } else {
                return config.maxR;
            }
        }

        function createPoint(colorData) {
            for (let h = 0; h < config.h; h += config.space) {
                for (let w = 0; w < config.w; w += config.space) {
                    let index = (h * config.w + w) * 4;
                    let color = colorData[index]
                    if (color === 255) {
                        let point = {
                            x: w,
                            y: h,
                            startX: ~~(Math.random() * config.w),
                            startY: ~~(Math.random() * config.h),
                            r: randomRadius()
                        };
                        let absX = Math.abs(point.x - point.startX);
                        let absY = Math.abs(point.y - point.startY);
                        point.xMove = absX > absY;
                        point.slope = absX / absY;
                        points.push(point);
                    }
                }
            }
        }

        function drawPoints() {
            if (finishedPointsCount < pointsCount) {
                requestAnimationFrame(() => {
                    this.drawPoints()
                })
            } else {
                this.callback && this.callback()
            }
            ctx.clearRect(0, 0, config.w, config.h);
            points.forEach((point) => {
                updatePoint(point);
                drawPoint(point);
            });
        }

        function loadLogo() {
            let img = new Image;
            img.onload = () => {
                ctx.drawImage(img, (config.w - img.width) / 2, (config.h - img.height) / 2 * 0.3);
                createPoint(ctx.getImageData(0, 0, config.w, config.h).data);
                pointsCount = points.length;
                this.drawPoints()
            };
            img.src = '../src/logo.png';
        }

        function updatePoint(point) {
            if (point.startX === point.x && point.startY === point.y) {
                return;
            }
            if (point.xMove) {
                if (Math.abs(point.startX - point.x) <= config.moveDistance) {
                    point.startX = point.x;
                    point.startY = point.y;
                } else {
                    if (point.startX > point.x) {
                        point.startX -= config.moveDistance;
                    } else {
                        point.startX += config.moveDistance;
                    }
                    if (point.startY > point.y) {
                        point.startY -= config.moveDistance / point.slope;
                    } else {
                        point.startY += config.moveDistance / point.slope;
                    }
                }
            } else {
                if (Math.abs(point.startY - point.y) <= config.moveDistance) {
                    point.startX = point.x;
                    point.startY = point.y;
                } else {
                    if (point.startX > point.x) {
                        point.startX -= config.moveDistance * point.slope;
                    } else {
                        point.startX += config.moveDistance * point.slope;
                    }
                    if (point.startY > point.y) {
                        point.startY -= config.moveDistance;
                    } else {
                        point.startY += config.moveDistance
                    }
                }
            }


            if (point.startX === point.x && point.startY === point.y) {
                finishedPointsCount ++
            }
        }

        function drawPoint(point) {
            ctx.beginPath();
            ctx.arc(point.startX, point.startY, point.r, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
        }

        return {
            points,
            drawPoints,
            loadLogo,
            init: function (callback) {
                this.loadLogo();
                this.callback = callback;
            },
        }
    })();

    particleLogo.init();

</script>
</body>
</html>